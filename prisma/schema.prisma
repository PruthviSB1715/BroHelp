generator client {
  provider = "prisma-client"
  output ="../generated/prisma"
}

datasource db {
  provider  = "postgresql"
}

// ─── ENUMS ───────────────────────────────────────────

enum TaskStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum TransactionReason {
  TASK_PAYMENT
  TASK_REFUND
  TOP_UP
  WITHDRAWAL
  BONUS
  PENALTY
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum ReportReason {
  SPAM
  FRAUD
  INAPPROPRIATE
  FAKE_TASK
  OTHER
}

// ─── USER ────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  username      String?   @unique
  password      String?
  image         String?
  bio           String?
  credits       Float     @default(0)
  rating        Float     @default(0)
  ratingCount   Int       @default(0)
  isVerified    Boolean   @default(false)
  isBanned      Boolean   @default(false)
  banReason     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts             Account[]
  sessions             Session[]
  postedTasks          Task[]              @relation("PostedBy")
  acceptedTasks        Task[]              @relation("AcceptedBy")
  sentMessages         Message[]           @relation("SentBy")
  ratingsGiven         Rating[]            @relation("RatingGiver")
  ratingsReceived      Rating[]            @relation("RatingReceiver")
  transactionsFrom     CreditTransaction[] @relation("TransactionFrom")
  transactionsTo       CreditTransaction[] @relation("TransactionTo")
  auditLogs            AuditLog[]
  reportsSubmitted     Report[]            @relation("ReportedBy")
  reportsReceived      Report[]            @relation("ReportedUser")
  conversationsAsA     Conversation[]      @relation("ConvA")
  conversationsAsB     Conversation[]      @relation("ConvB")
}

// ─── AUTH.JS REQUIRED ─────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  ip           String?
  userAgent    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── TASK ─────────────────────────────────────────────

model Task {
  id            String     @id @default(cuid())
  title         String
  description   String
  category      String?
  tags          String[]
  attachments   String[]
  credits       Float
  estimatedTime Int
  location      String?
  isRemote      Boolean    @default(true)
  status        TaskStatus @default(OPEN)
  expiresAt     DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  posterId   String
  poster     User    @relation("PostedBy", fields: [posterId], references: [id])
  acceptorId String?
  acceptor   User?   @relation("AcceptedBy", fields: [acceptorId], references: [id])

  messages     Message[]           @relation("TaskMessages")
  ratings      Rating[]
  transactions CreditTransaction[]
  reports      Report[]
}

// ─── CONVERSATION ─────────────────────────────────────

model Conversation {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  participantAId String
  participantA   User     @relation("ConvA", fields: [participantAId], references: [id])

  participantBId String
  participantB   User     @relation("ConvB", fields: [participantBId], references: [id])

  messages       Message[] @relation("ConvMessages")

  @@unique([participantAId, participantBId])
}

// ─── MESSAGE ──────────────────────────────────────────

model Message {
  id             String        @id @default(cuid())
  content        String
  fileUrl        String?
  isRead         Boolean       @default(false)
  createdAt      DateTime      @default(now())

  conversationId String
  conversation   Conversation  @relation("ConvMessages", fields: [conversationId], references: [id])

  senderId       String
  sender         User          @relation("SentBy", fields: [senderId], references: [id])

  taskId         String?
  task           Task?         @relation("TaskMessages", fields: [taskId], references: [id])
}

// ─── RATING ───────────────────────────────────────────

model Rating {
  id         String   @id @default(cuid())
  score      Int
  comment    String?
  createdAt  DateTime @default(now())

  taskId     String
  task       Task   @relation(fields: [taskId], references: [id])
  giverId    String
  giver      User   @relation("RatingGiver", fields: [giverId], references: [id])
  receiverId String
  receiver   User   @relation("RatingReceiver", fields: [receiverId], references: [id])

  @@unique([taskId, giverId])
}

// ─── CREDIT TRANSACTION ───────────────────────────────

model CreditTransaction {
  id        String            @id @default(cuid())
  amount    Float
  reason    TransactionReason
  status    TransactionStatus @default(PENDING)
  note      String?
  createdAt DateTime          @default(now())

  fromId String?
  from   User?   @relation("TransactionFrom", fields: [fromId], references: [id])
  toId   String?
  to     User?   @relation("TransactionTo", fields: [toId], references: [id])
  taskId String?
  task   Task?   @relation(fields: [taskId], references: [id])
}

// ─── AUDIT LOG ────────────────────────────────────────

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  ip        String?
  userAgent String?
  meta      Json?
  createdAt DateTime @default(now())
}

// ─── REPORT ───────────────────────────────────────────

model Report {
  id             String       @id @default(cuid())
  reason         ReportReason
  description    String?
  resolved       Boolean      @default(false)
  createdAt      DateTime     @default(now())

  reportedById   String
  reportedBy     User         @relation("ReportedBy", fields: [reportedById], references: [id])
  reportedUserId String?
  reportedUser   User?        @relation("ReportedUser", fields: [reportedUserId], references: [id])
  taskId         String?
  task           Task?        @relation(fields: [taskId], references: [id])
}